<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Estudos FATEC - ADS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN (para rodar no navegador sem build) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel para transpilar JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Estilos básicos para o 'prose' do summary */
      .prose h3 {
        font-size: 1.5rem; /* text-2xl */
        font-weight: 600; /* font-semibold */
        margin-bottom: 1rem; /* mb-4 */
        border-bottom: 2px solid theme('colors.gray.300'); /* border-b-2 border-gray-300 */
        padding-bottom: 0.5rem; /* pb-2 */
      }
      .prose strong {
        font-weight: 700; /* font-bold */
      }
    </style>
</head>
<body class="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col">
    <div id="root"></div>

    <script type="text/babel">
        // Componente principal do aplicativo
        function App() {
            // Dados das matérias a serem exibidas na navegação
            const subjectsMetaData = [
                { name: "Administração Geral", id: "adm-geral" },
                { name: "Algoritmos", id: "algoritmos" },
                { name: "Matemática Discreta", id: "mat-discreta" },
                { name: "Laboratório de Hardware", id: "lab-hardware" },
                { name: "Arquitetura e Organização Computacional", id: "arq-comp" },
            ];

            // Estados do aplicativo
            const [selectedSubject, setSelectedSubject] = React.useState(null); // Matéria selecionada
            const [currentSubjectContent, setCurrentSubjectContent] = React.useState(null); // Conteúdo da matéria (resumo, perguntas)
            const [userAnswers, setUserAnswers] = React.useState({}); // Respostas do usuário para cada pergunta
            const [geminiFeedback, setGeminiFeedback] = React.useState({}); // Feedback da IA para cada pergunta
            const [loadingContent, setLoadingContent] = React.useState(false); // Indica se o conteúdo da matéria está sendo carregado
            const [loadingFeedback, setLoadingFeedback] = React.useState({}); // Indica se o feedback de uma pergunta específica está sendo carregado

            // Chave da API da Gemini - Substitua pela sua chave real
            const API_KEY = "AIzaSyDXK-3nAi7TKlf8nD8V4D0shvPDLYdwRp4";

            // Função assíncrona para gerar conteúdo da matéria usando a API da Gemini
            const generateContentForSubject = async (subjectId, subjectName) => {
                // Reseta estados ao carregar nova matéria
                setCurrentSubjectContent(null);
                setUserAnswers({});
                setGeminiFeedback({});
                setLoadingContent(true);

                try {
                    const prompt = `
                        Gere um resumo detalhado sobre "${subjectName}" em nível universitário introdutório, com foco em conceitos fundamentais para o ensino médio. Use markdown para títulos (###) e negrito (**) no resumo.
                        Em seguida, gere 4 perguntas abertas baseadas no resumo (com uma 'answer' detalhada para cada).
                        O conteúdo do resumo deve ser diretamente relevante para as perguntas geradas, e e as perguntas devem ter um nível de dificuldade moderado.
                        A resposta deve ser estritamente em formato JSON, seguindo esta estrutura:
                        {
                          "summary": "Texto do resumo detalhado com markdown para títulos (###) e negrito (**).",
                          "questions": [
                            {
                              "type": "text",
                              "question": "Texto da primeira pergunta aberta?",
                              "answer": "Resposta ideal detalhada para a primeira pergunta."
                            },
                            {
                              "type": "text",
                              "question": "Texto da segunda pergunta aberta?",
                              "answer": "Resposta ideal detalhada para a segunda pergunta."
                            },
                            {
                              "type": "text",
                              "question": "Texto da terceira pergunta aberta?",
                              "answer": "Resposta ideal detalhada para a terceira pergunta."
                            },
                            {
                              "type": "text",
                              "question": "Texto da quarta pergunta aberta?",
                              "answer": "Resposta ideal detalhada para a quarta pergunta."
                            }
                          ]
                        }
                    `;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    summary: { "type": "STRING" },
                                    questions: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                type: { "type": "STRING" },
                                                question: { "type": "STRING" },
                                                answer: { "type": "STRING" }
                                            }
                                        }
                                    }
                                },
                                required: ["summary", "questions"]
                            }
                        }
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    let parsedContent;

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        try {
                            // Tenta parsear diretamente
                            parsedContent = JSON.parse(jsonString);
                        } catch (parseError) {
                            // Se falhar, tenta extrair de um bloco de código markdown
                            const match = jsonString.match(/```json\n([\s\S]*?)\n```/);
                            if (match && match[1]) {
                                parsedContent = JSON.parse(match[1]);
                            } else {
                                throw new Error("Erro ao extrair JSON da resposta da IA.");
                            }
                        }

                        // Valida a estrutura
                        if (typeof parsedContent.summary === 'string' && Array.isArray(parsedContent.questions)) {
                            setCurrentSubjectContent(parsedContent);
                        } else {
                            throw new Error("Estrutura JSON inválida da resposta da IA.");
                        }
                    } else {
                        throw new Error("Nenhum conteúdo gerado pela IA.");
                    }
                } catch (error) {
                    console.error("Erro ao gerar conteúdo:", error);
                    setCurrentSubjectContent({
                        summary: `### Erro ao carregar conteúdo\nOcorreu um erro: **${error.message}**. Por favor, tente novamente.`,
                        questions: []
                    });
                } finally {
                    setLoadingContent(false);
                }
            };

            // Efeito para carregar conteúdo quando a matéria selecionada muda
            React.useEffect(() => {
                if (selectedSubject) {
                    const subject = subjectsMetaData.find(s => s.id === selectedSubject);
                    if (subject) {
                        generateContentForSubject(subject.id, subject.name);
                    }
                }
            }, [selectedSubject]); // Dependência: selectedSubject

            // Lida com a mudança das respostas do usuário
            const handleAnswerChange = (questionIndex, value) => {
                setUserAnswers(prevAnswers => ({
                    ...prevAnswers,
                    [questionIndex]: value
                }));
                // Limpa o feedback anterior para a pergunta modificada
                setGeminiFeedback(prevFeedback => {
                    const newFeedback = { ...prevFeedback };
                    delete newFeedback[questionIndex];
                    return newFeedback;
                });
            };

            // Função assíncrona para obter feedback da IA para uma resposta
            const getGeminiFeedback = async (questionObj, userAnswer, questionIndex) => {
                setLoadingFeedback(prev => ({ ...prev, [questionIndex]: true }));
                // Para perguntas abertas, a resposta esperada é diretamente a propriedade 'answer'
                const expectedAnswer = questionObj.answer;

                try {
                    const prompt = `
                        Analise a seguinte pergunta, a resposta esperada/correta e a resposta do usuário. Forneça um feedback detalhado estritamente no formato JSON.
                        Pergunta: "${questionObj.question}"
                        Resposta Esperada/Correta: "${expectedAnswer}"
                        Resposta do Usuário: "${userAnswer || 'Nenhuma resposta fornecida'}"

                        A resposta deve ser estritamente em formato JSON, seguindo esta estrutura:
                        {
                          "isCorrect": boolean,
                          "feedback": "Texto do feedback geral.",
                          "errorsExplained": "Explicação dos erros (se houver).",
                          "tipsForImprovement": "Dicas para melhorar (se houver).",
                          "performanceLevel": "Básico" | "Intermediário" | "Avançado"
                        }
                    `;

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    isCorrect: { "type": "BOOLEAN" },
                                    feedback: { "type": "STRING" },
                                    errorsExplained: { "type": "STRING" },
                                    tipsForImprovement: { "type": "STRING" },
                                    performanceLevel: { "type": "STRING", "enum": ["Básico", "Intermediário", "Avançado"] }
                                },
                                required: ["isCorrect", "feedback", "errorsExplained", "tipsForImprovement", "performanceLevel"]
                            }
                        }
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    let parsedFeedback;

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonString = result.candidates[0].content.parts[0].text;
                        try {
                            parsedFeedback = JSON.parse(jsonString);
                        } catch (parseError) {
                            const match = jsonString.match(/```json\n([\s\S]*?)\n```/);
                            if (match && match[1]) {
                                parsedFeedback = JSON.parse(match[1]);
                            } else {
                                throw new Error("Erro ao extrair JSON do feedback da IA.");
                            }
                        }
                        setGeminiFeedback(prevFeedback => ({
                            ...prevFeedback,
                            [questionIndex]: parsedFeedback
                        }));
                    } else {
                        throw new Error("Nenhum feedback gerado pela IA.");
                    }
                } catch (error) {
                    console.error("Erro ao obter feedback:", error);
                    setGeminiFeedback(prevFeedback => ({
                        ...prevFeedback,
                        [questionIndex]: {
                            isCorrect: false,
                            feedback: `Erro ao obter feedback: ${error.message}`,
                            errorsExplained: "",
                            tipsForImprovement: "",
                            performanceLevel: "Básico"
                        }
                    }));
                } finally {
                    setLoadingFeedback(prev => ({ ...prev, [questionIndex]: false }));
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col">
                    {/* Cabeçalho Fixo */}
                    <header className="bg-red-700 text-white p-4 shadow-lg fixed w-full z-10 rounded-b-xl">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-3xl font-extrabold tracking-tight">FATEC - ADS <span className="text-red-200">Plataforma de Estudos</span></h1>
                            <nav>
                                <ul className="flex space-x-6">
                                    {subjectsMetaData.map((subject) => (
                                        <li key={subject.id}>
                                            <button
                                                onClick={() => setSelectedSubject(subject.id)}
                                                className={`py-2 px-4 rounded-lg font-semibold transition-all duration-300 ease-in-out
                                                    ${selectedSubject === subject.id
                                                        ? 'bg-white text-red-700 shadow-md transform scale-105'
                                                        : 'text-white hover:bg-red-800 hover:shadow-md hover:transform hover:scale-105'
                                                    }`}
                                            >
                                                {subject.name}
                                            </button>
                                        </li>
                                    ))}
                                </ul>
                            </nav>
                        </div>
                    </header>

                    {/* Conteúdo Principal */}
                    <main className="flex-grow container mx-auto p-6 pt-24 pb-16"> {/* Ajuste o padding-top para o cabeçalho fixo */}
                        {!selectedSubject && (
                            <div className="text-center mt-20 p-8 bg-white rounded-xl shadow-lg border border-gray-200">
                                <h2 className="text-4xl font-bold text-gray-800 mb-4">Bem-vindo à Plataforma de Estudos!</h2>
                                <p className="text-xl text-gray-600">Selecione uma matéria acima para começar a explorar.</p>
                                <p className="mt-6 text-lg text-gray-500">Prepare-se para o curso de Análise e Desenvolvimento de Sistemas da FATEC!</p>
                            </div>
                        )}

                        {loadingContent && (
                            <div className="flex justify-center items-center h-64">
                                <div className="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-red-500"></div>
                                <p className="ml-4 text-xl text-gray-600">Carregando conteúdo, por favor aguarde...</p>
                            </div>
                        )}

                        {currentSubjectContent && (
                            <div className="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                                <h2 className="text-4xl font-bold text-red-700 mb-6 text-center">
                                    {subjectsMetaData.find(s => s.id === selectedSubject)?.name}
                                </h2>

                                {/* Seção do Resumo */}
                                <section className="mb-10">
                                    <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-b-2 pb-2 border-gray-300">Resumo</h3>
                                    <div className="prose max-w-none leading-relaxed text-gray-700"
                                         dangerouslySetInnerHTML={{ __html: currentSubjectContent.summary.replace(/\n/g, '<br/>') }} />
                                </section>

                                {/* Seção de Perguntas */}
                                <section>
                                    <h3 className="text-2xl font-semibold text-gray-700 mb-6 border-b-2 pb-2 border-gray-300">Perguntas</h3>
                                    {currentSubjectContent.questions.map((q, qIndex) => (
                                        <div key={qIndex} className="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm border border-gray-100">
                                            <p className="font-medium text-lg mb-4 text-gray-800">
                                                <span className="text-red-600 mr-2">Questão {qIndex + 1}:</span> {q.question}
                                            </p>

                                            {/* Agora apenas input type="text" */}
                                            <input
                                                type="text"
                                                value={userAnswers[qIndex] || ''}
                                                onChange={(e) => handleAnswerChange(qIndex, e.target.value)}
                                                placeholder="Digite sua resposta aqui..."
                                                disabled={loadingFeedback[qIndex]}
                                                className="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 transition-all duration-200 disabled:bg-gray-100"
                                            />

                                            <button
                                                onClick={() => getGeminiFeedback(q, userAnswers[qIndex], qIndex)}
                                                disabled={loadingFeedback[qIndex] || !userAnswers[qIndex]}
                                                className="mt-4 px-6 py-2 bg-red-700 text-white font-semibold rounded-lg shadow-md hover:bg-red-800 transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                {loadingFeedback[qIndex] ? (
                                                    <div className="flex items-center justify-center">
                                                        <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div>
                                                        Verificando...
                                                    </div>
                                                ) : (
                                                    "Verificar Resposta"
                                                )}
                                            </button>

                                            {/* Exibição do Feedback da IA */}
                                            {geminiFeedback[qIndex] && (
                                                <div className={`mt-6 p-5 rounded-lg shadow-inner transition-all duration-300 ease-in-out
                                                    ${geminiFeedback[qIndex].isCorrect ? 'bg-green-50 border border-green-400' : 'bg-red-50 border border-red-400'}
                                                `}>
                                                    <h4 className="font-bold text-lg mb-3 flex items-center">
                                                        {geminiFeedback[qIndex].isCorrect ? (
                                                            <span className="text-green-600 mr-2">✓ Status: Correto!</span>
                                                        ) : (
                                                            <span className="text-red-600 mr-2">✗ Status: Incorreto!</span>
                                                        )}
                                                    </h4>
                                                    <p className="mb-2 text-gray-700">
                                                        <span className="font-semibold">Nível de Desempenho:</span> {geminiFeedback[qIndex].performanceLevel}
                                                    </p>
                                                    <p className="mb-2 text-gray-700">
                                                        <span className="font-semibold">Seu Feedback:</span> {geminiFeedback[qIndex].feedback}
                                                    </p>
                                                    {geminiFeedback[qIndex].errorsExplained && (
                                                        <p className="mb-2 text-gray-700">
                                                            <span className="font-semibold">Erros Explicados:</span> {geminiFeedback[qIndex].errorsExplained}
                                                        </p>
                                                    )}
                                                    {geminiFeedback[qIndex].tipsForImprovement && (
                                                        <p className="text-gray-700">
                                                            <span className="font-semibold">Dicas para Melhorar:</span> {geminiFeedback[qIndex].tipsForImprovement}
                                                        </p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </section>
                            </div>
                        )}
                    </main>

                    {/* Rodapé Simples */}
                    <footer className="bg-gray-800 text-white p-4 text-center text-sm mt-8 rounded-t-xl shadow-inner">
                        <div className="container mx-auto">
                            &copy; {new Date().getFullYear()} Plataforma de Estudos FATEC - ADS. Todos os direitos reservados.
                        </div>
                    </footer>
                </div>
            );
        }

        // Renderiza o componente App na div com id "root"
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
